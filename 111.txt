package com.example.testwebview;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.os.Bundle;
import android.view.KeyEvent;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.Toast;

public class WebViewActivity extends Activity {

	final static int TOMAINCODE = 001;//主页面返回码
	final static String TOMAINVALUE ="loginValue";//主页面返回值
	private WebView webView;
	private ProgressDialog progressBar;
	private boolean isOk=false;//是否java调用js 函数成功

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.webview);
		initView();
	}


	/**
	 * WebViewClient 代理对象
	 */
	class MyWebViewClient extends WebViewClient {

		@Override
		public boolean shouldOverrideUrlLoading(WebView view, String url) {
			view.loadUrl(url);
			return super.shouldOverrideUrlLoading(view, url);
		}

		@Override
		public void onPageFinished(WebView view, String url) {
			
			super.onPageFinished(view, url);
			
			//取消进度
			if (progressBar.isShowing()) {
				progressBar.dismiss();
			}
			
            // html加载完成之后，添加监听js函数 
			addChangeListner();
			addChangeTableListner();
			addClickListner();
		}
		
		@Override
		public void onPageStarted(WebView view, String url, Bitmap favicon) {
			super.onPageStarted(view, url, favicon);
		}

		@Override
		public void onReceivedError(WebView view, int errorCode, String description, String failingUrl) {
			 super.onReceivedError(view, errorCode, description, failingUrl);
			 
			Toast.makeText(WebViewActivity.this, "网页加载出错！", Toast.LENGTH_LONG);
		}

	}

	/**
	 * 初始化view
	 */
	protected void initView() {
		
		// 设计进度条
		progressBar = ProgressDialog.show(WebViewActivity.this, null, "正在进入网页，请稍后…");
		// 获得WebView组件
		webView = (WebView)findViewById(R.id.myWebView);
		// 启用javascript  
		webView.getSettings().setJavaScriptEnabled(true);
		
		webView.loadUrl("file:///android_asset/test.html");
		
		 // 添加js交互接口类，并起别名 clicklistner  
		webView.addJavascriptInterface(new JavascriptInterface(WebViewActivity.this), "clicklistner");  
        
		// 设置视图客户端
		webView.setWebViewClient(new MyWebViewClient());
		
	}
	
	@Override
	public boolean onKeyDown(int keyCode, KeyEvent event) {
		if (keyCode == KeyEvent.KEYCODE_BACK) {
			
			new JavascriptInterface(WebViewActivity.this).javaDoJs();
			
	      	if(isOk){//关闭，退出页面
	      		webView.goBack();
	      		finish();
	      		return true;
	      	}
		}
		return super.onKeyDown(keyCode, event);
	}
	
	
	// 注入js函数监听 
    private void addClickListner() {
        // 这段js函数的功能就是，给指定button添加clicklistnerjs交互接口
    	webView.loadUrl("javascript:(function(){" +
        "var obj = document.getElementById(\"ok\"); " +
        "obj.onclick=function TestClick() " +
        	"{" +
        	"	var uNameObj = document.getElementById(\"username\");" +
        	"	var pWordObj = document.getElementById(\"password\");" +
        	" if (!uNameObj && typeof(uNameObj)!=\"undefined\" && uNameObj!=0) {" +
        		"	var uNameValue=uNameObj.value+\"\"; " +
        	"}else{" +
        	"	var uNameValue=\"姓名空\"; " +
        	"}" +
        	
        	"if (!pWordObj && typeof(pWordObj)!=\"undefined\" && pWordObj!=0) {" +
    			"	var pWordValue=pWordObj.value+\"\"; " +
	    	"}else{" +
	    	"	var pWordValue=\"密码空\"; " +
	    	"}" +
    		
			"	var mStr=uNameValue+ \"&&\"+pWordValue;" +
        	"   window.clicklistner.result(mStr); " +
        	"}  " +
        "})()");
    	
    	
      	webView.loadUrl("javascript:(function(){" +
        		   "var cancelObj = document.getElementById(\"MC_BTN_IDOK\"); " +
        		   "cancelObj.onclick=function CallWindowFun() " +
        		   "{" +
        		   		"window.clicklistner.resultNoValue();" +
     	     	"}  " +
        	        "})()");
      	
       	webView.loadUrl("javascript:(function(){" +
       		   "var cancelObj = document.getElementById(\"MC_BTN_IDCANCEL\"); " +
       		   "cancelObj.onclick=function CallWindowFun() " +
       		   "{" +
       		   		"window.clicklistner.resultNoValue();" +
    	     	"}  " +
       	        "})()");
    }
    
    private void addChangeListner() {
    	webView.loadUrl("javascript:(function(){" +
    			"var obj = document.getElementById(\"ok\"); " +
    			"obj.innerHTML=\"提交\";" +
		        "})()");
    }

    private void addChangeTableListner() {
    	webView.loadUrl("javascript:(function(){" +
    			"var table=document.createElement(\"table\");" +
    			"table.border=\"0\";" +
    			"table.width=\"100%\";" +
    			"table.id=\"FootButtonTable\";" +
    			"table.cellspacing=\"0\";" +
    			
    			"var tbody=document.createElement(\"tbody\");" +
    					"var tr=document.createElement(\"tr\");" +
    							"var td=document.createElement(\"td\");" +
    							"td.innerHTML=\"&nbsp;\";" +
    					"tr.appendChild(td);" +
    					"tbody.appendChild(tr);" +
    					
				"var tr=document.createElement(\"tr\");" +
				"var td=document.createElement(\"td\");" +
				"td.align=\"center\";" +
				
				"var bt1=document.createElement(\"input\");" +
					 "bt1.type=\"button\";" +
					 "bt1.id=\"MC_BTN_IDOK\";" +
					 "bt1.value=\"MC_OK\";" +
					 "bt1.onclick=\"CallWindowFun\";" +
				"td.appendChild(bt1);" +
					 
				"var bt2=document.createElement(\"input\");" +
				 "bt2.type=\"button\";" +
				 "bt2.id=\"MC_BTN_IDCANCEL\";" +
				 "bt2.value=\"MC_Cancel\";" +
				 "bt2.onclick=\"CallWindowFun\";" +
				 "td.appendChild(bt2);" +
				 
				"tr.appendChild(td);" +
				"tbody.appendChild(tr);" +
				
    			"table.border=\"1\";" +
    			"table.appendChild(tbody);" +
    			
    			"document.body.appendChild(table);" +
		        "})()");
    }
    
    /**
     * js通信接口
     * 作为回调使用
     */
    public class JavascriptInterface {
  
        private Context context;  
  
        public JavascriptInterface(Context context) {  
            this.context = context;  
        }
        
        public void result(String mStr) {
        	Intent intent=new Intent(WebViewActivity.this,MainActivity.class);
        	intent.putExtra(TOMAINVALUE, mStr);
        	setResult(TOMAINCODE, intent);
        	finish();
        }
        
        public void resultNoValue() {
        	Toast.makeText(WebViewActivity.this,"默认按钮被点击", 1).show();
        	isOk=true;
        }
        
        public void javaDoJs() {
        	//调用提交按钮的TestClick()方法
          	webView.loadUrl("javascript:(function(){" +
          			"document.getElementById(\"ok\").onclick();" +
          			"})()");
        }  
    }
}
